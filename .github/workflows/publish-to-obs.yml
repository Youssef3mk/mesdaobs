name: Publish Mesa spec to OBS

on:
  push:
    branches: [ main ]
  # release:
  #   types: [published]   # لو عايز يشتغل بس على releases، شيل # من هنا

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install osc
        run: |
          sudo apt-get update
          sudo apt-get install -y osc

      - name: Setup osc configuration
        env:
          OBS_TOKEN: ${{ secrets.OBS_TOKEN }}
        run: |
          mkdir -p ~/.config/osc
          cat > ~/.config/osc/oscrc << 'EOF'
          [general]
          apiurl=https://api.opensuse.org

          [https://api.opensuse.org]
          user=youssef3mk
          pass=$OBS_TOKEN
          credentials_mgr_class=osc.credentials.ObfuscatedConfigFileCredentialsManager
          EOF

      - name: Test authentication (whoami)
        run: osc whoami || { echo "Authentication failed - check OBS_TOKEN secret"; exit 1; }

      - name: Checkout OBS package
        run: |
          osc checkout home:youssef3mk mesame || { echo "Failed to checkout home:youssef3mk / mesame - check name"; exit 1; }
          cd home:youssef3mk/mesame

      - name: Copy updated files
        run: |
          cp -f ../mesa.spec . || { echo "mesa.spec not found in repo root"; exit 1; }
          cp -f ../_service . 2>/dev/null || true

      - name: Commit changes to OBS
        run: |
          cd home:youssef3mk/mesame
          osc addremove --force || true
          osc commit -m "Automatic update from GitHub commit ${{ github.sha }} - ${{ github.event.head_commit.message }}" || { echo "Commit failed - see osc output above"; exit 1; }

      - name: Trigger rebuild (optional)
        run: |
          cd home:youssef3mk/mesame
          osc rebuild || true
